<template>
  <v-container>
    <v-row>
      <v-col cols='12' class="align-center py-0 my-0">
        <v-btn :ripple="false" link text class="px-0 back_button" to="/order/delivery">
          <v-icon align='center' justify='center' class="mr-3 mt-0">mdi-chevron-left</v-icon>
          <span class="text-h6 text-capitalize font-weight-bold text-decoration-underline">Back</span>
        </v-btn>
      </v-col>
      <v-col cols='8'>
        <v-card flat class="d-flex align-center pl-0 py-5 mb-7" to="/order/delivery/new">
          <v-row class="align-center" align='center'>
            <v-col class="d-flex align-center">
              <v-icon color="#E0CF5E" size='25' class="delivery_icon mr-5">mdi-basket-outline</v-icon>
              <span class="text-subtitle-1 font-weight-bold">{{address.type}} : {{address.house}}, {{address.street}}, {{address.city}}, {{address.pincode}}</span>
              <span>{{cart}}</span>
            </v-col>
          </v-row>
        </v-card>
        <v-divider class="mt-5 "></v-divider>
      </v-col>
      <v-col cols='8'>
        <v-expansion-panels multiple flat light >
          <v-expansion-panel
            v-for="(types,i) in Object.keys(group_by_category)"
            :key="i"
            class="pb-4"
          >
            <v-card class="pa-0 primary--text" outlined tile>
              <v-card-title class="pa-0">
                <v-expansion-panel-header class="text-h6 font-weight-regular">
                  {{types}}
                  <template v-slot:actions>
                    <v-icon color="primary">mdi-menu-down</v-icon>
                  </template>
                </v-expansion-panel-header>
              </v-card-title>
            </v-card>
            <v-expansion-panel-content>
              <v-list two-line>
                <!-- <v-list-item-group multiple> -->
                  <!-- active-class="primary" -->
                  <v-row>
                    <template v-for="(item,j) in group_by_category[types]">
                      <v-col cols="6" :key="j">
                          <v-list-item @click="selecting(item)">
                            <template>
                               <!-- v-slot:default="{ active }" -->
                              <v-list-item-content>
                                <v-list-item-title class="text-h6 mb-3 forth--text font-weight-bold" v-text="item.item"></v-list-item-title>
                                <v-list-item-subtitle v-text="item.description"></v-list-item-subtitle>
                              </v-list-item-content>
                              <v-list-item-action>
                                <v-list-item-action-text class="text-h5 font-weight-bold forth--text" v-text="'CA$'+item.price"></v-list-item-action-text>
                                <v-list-item-action-text class="text-h5 font-weight-bold forth--text" v-if="item.count!=0" v-text="item.count"></v-list-item-action-text>
                              </v-list-item-action>
                            </template>
                          </v-list-item>
                        <v-divider v-if="j + 1 < types.length" :key="j"></v-divider>
                      </v-col>
                    </template>
                  </v-row>
                <!-- </v-list-item-group> -->
              </v-list>
            </v-expansion-panel-content>
          </v-expansion-panel>
        </v-expansion-panels>
        <v-dialog
          persistent
          v-model="dialog"
          max-width="500px"
        >
          <v-card>
            <v-card-title v-if="dialog_object!=null">
              {{dialog_object.item}}
            </v-card-title>
            <v-list shaped v-if="dialog_object!=null">
              <v-list-item-group
                v-model="config"
                multiple
              >
                <template>
                  <v-list-item
                    v-for="(item, i) in dialog_object.configure.sides"
                    :key="`item-${i}`"
                    :value="item.item"
                    active-class="deep-purple--text text--accent-4"
                  >
                    <template v-slot:default="{ active }">
                      <v-list-item-content>
                        <v-list-item-title v-text="item.name">
                        </v-list-item-title>
                      </v-list-item-content>

                      <v-list-item-action>
                        <v-checkbox
                          :input-value="active"
                          color="deep-purple accent-4"
                        ></v-checkbox>
                      </v-list-item-action>
                    </template>
                  </v-list-item>
                </template>
              </v-list-item-group>
            </v-list>
            <v-card-actions>
              <v-btn
                color="primary"
                text
                @click="closing_dialog"
              >
                Close
              </v-btn>
              <v-spacer></v-spacer>
              <v-btn
                color="primary"
                text
                @click="adding_cart(dialog_object,config)"
              >
                Add
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-col>
      <v-col>
        <v-card class="pa-5 white--text mb-5" outlined tile>
          <v-btn x-large block depressed :ripple="false" tile color="primary" >LOGIN</v-btn>
        </v-card>
        <v-card class="pa-0 white--text" outlined tile>
          <v-card-title class="headline primary px-5">
            Basket
            <v-spacer></v-spacer>
            CA${{total_cart_price.toFixed(2)}}
          </v-card-title>
          <v-list two-line v-if="cart!=[]">
            <template v-for="(item,j) in cart" >
              <v-list-item :key="j">
                <template>
                  <v-list-item-content>
                    <v-list-item-title class="text-h6 mb-3 forth--text font-weight-bold" v-text="item.item"></v-list-item-title>
                    <v-list-item-subtitle v-for="i in item.configure.sides" v-text="i.name" :key="i.name"></v-list-item-subtitle>
                  </v-list-item-content>
                  <v-list-item-action>
                    <v-list-item-action-text class="text-h5 font-weight-bold forth--text" v-text="'CA$'+item.total_price.toFixed(2)"></v-list-item-action-text>
                    <span>
                      <v-btn outlined icon color="grey lighten-1">
                        -
                      </v-btn>
                      {{item.count}}
                      <v-btn outlined icon color="grey lighten-1" @click="increase(item._id,j)">
                        +
                      </v-btn>
                    </span>
                  </v-list-item-action>
                </template>
              </v-list-item>
              <!-- <v-divider v-if="j + 1 < types.length" :key="j"></v-divider> -->
            </template>
          </v-list>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>
<script>
// import axios from "axios"
export default {
  data:() => ({
    cart:[],
    dialog: false,
    selected: [],
    dialog_object: null,
    config:[],
    address: null,
    menu: null,
    group_by_category: "",
    item_price: 0,
    total_price: 0
  }),
  methods: {
    selecting: function(item){
      if(item.configure){
        this.dialog_object = item
        this.dialog = true
      }
      else{
        item.count +=1
        var flag = 0
        if(this.cart.length != 0){
          for (let index = 0; index < this.cart.length; index++) {
            if(item._id == this.cart[index]._id){
              this.cart[index].count += 1
              this.cart[index].total_price = Number(this.cart[index].count) * Number(this.cart[index].price)
              flag = 1
              break
            }
          }
          if(flag == 0){
            let temp = {
              "_id": item._id,
              "item": item.item,
              "price": item.price,
              "total_price": Number(item.price)*Number(item.count),
              "count": 1,
              "configure": {
                "sides": []
              }
            }
            this.cart.push(temp)
          }
        }
        else{
          let temp = {
            "_id": item._id,
            "item": item.item,
            "price": item.price,
            "total_price": item.price*item.count,
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          this.cart.push(temp)
        }
      }
    },
    adding_cart: function(object, config){
      config.sort()
      object.count +=1
      var isObject = function (object) {
        return object != null && typeof object === 'object';
      }
      var deepEqual = function (object1, object2) {
        var keys1 = Object.keys(object1);
        var keys2 = Object.keys(object2);
        const toRemove = ["category", "description", "price", "total_price", "count"]
        keys1 = keys1.filter( ( el ) => !toRemove.includes( el ) )
        keys2 = keys2.filter( ( el ) => !toRemove.includes( el ) )
        if (keys1.length !== keys2.length) {
          return false;
        }

        for (const key of keys1) {
          const val1 = object1[key];
          const val2 = object2[key];
          const areObjects = isObject(val1) && isObject(val2);
          if (
            areObjects && !deepEqual(val1, val2) ||
            !areObjects && val1 !== val2
          ) {
            return false;
          }
        }

        return true;
      }
      if(this.cart.length == 0){
        if(config.length == 0){
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "total_price": Number(object.price)*Number(object.count),
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          this.cart.push(temp)
        }
        else{
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "total_price": object.price*object.count,
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          var sides_total_price = 0
          for (let index = 0; index < config.length; index++) {
            temp.configure.sides.push(object.configure.sides[config[index]])
            // temp.configure.sides[index].count = 1
            sides_total_price += Number(temp.configure.sides[index].price)
          }
          temp.total_price = temp.count * (temp.price + sides_total_price)
          this.cart.push(temp)
        }
      }
      else{
        var flag = 0
        if(config.length == 0){
          for (let index = 0; index < this.cart.length; index++) {
            if(this.cart[index].configure.sides.length == 0){
              if(object._id == this.cart[index]._id){
                this.cart[index].count += 1
                this.cart[index].total_price = Number(this.cart[index].count) * Number(this.cart[index].price)
                flag = 1
                break
              }
            }
          }
          if(flag == 0){
            let temp = {
              "_id": object._id,
              "item": object.item,
              "price": object.price,
              "total_price": Number(object.price),
              "count": 1,
              "configure": {
                "sides": []
              }
            }
            this.cart.push(temp)
          }
        }
        else{
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "total_price": 0,
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          for (let index = 0; index < config.length; index++) {
            temp.configure.sides.push(object.configure.sides[config[index]])
          }
          for (let index = 0; index < this.cart.length; index++) {
            if(deepEqual(temp,this.cart[index])){
              this.cart[index].count += 1
              sides_total_price = 0
              for (let index = 0; index < config.length; index++) {
                sides_total_price += Number(temp.configure.sides[index].price)
              }
              this.cart[index].total_price = Number(this.cart[index].count) * (Number(this.cart[index].price) + sides_total_price)
              flag = 1
              break
            }
          }
          if(flag == 0){
            sides_total_price = 0
            for (let index = 0; index < config.length; index++) {
              sides_total_price += Number(temp.configure.sides[index].price)
            }
            temp.total_price = temp.count * (temp.price + sides_total_price)
            this.cart.push(temp)
          }

        }
      }
      this.config = []
      this.dialog = false
    },
    increase: function(id,index){
      this.cart[index].count ++
      this.cart[index].total_price = this.cart[index].price * this.cart[index].count
    },
    closing_dialog: function(){
      this.config = []
      this.dialog = false
    }

  },
  computed: {
    configlist(){
      return this.info.filter(i => i.col === 'one')
    },
    total_cart_price: function(){
      return (this.cart.reduce((prev, cur) => prev + cur.total_price, 0))
    }
  },
  created(){
    this.address = this.$store.state.address
    this.menu = this.$store.state.menu
    this.menu.forEach((element,i) => {
      element["_id"] = i;
    })
    var groupBy = function(xs, key) {
      return xs.reduce(function(rv, x) {
        (rv[x[key]] = rv[x[key]] || []).push(x);
        return rv;
      }, {});
    };
    var groubedByTeam= groupBy(this.menu, 'category')
    this.group_by_category = groubedByTeam
  }
}
</script>

// <v-menu persistent v-model="dialog" :nudge-width="200" offset-x>
  // <v-card>
  //   <v-card-title>
  //     {{dialog_object.item}}
  //   </v-card-title>
  //   <v-card-actions>
  //     <v-btn
  //       color="primary"
  //       text
  //       @click="dialog=false"
  //     >
  //       Close
  //     </v-btn>
  //   </v-card-actions>
  // </v-card>
// </v-menu>


Backup :- 2


<script>
// import axios from "axios"
export default {
  data:() => ({
    inset: false,
    openedPanels: [0,1],
    dialog: false,
    selected: [],
    menu: null,
    dialog_object: null,
    config:[],
    address: null,
    item_price: 0,
    total_price: 0
  }),
  methods: {
    selecting: function(item){
      if(item.configure){
        this.dialog_object = item
        this.dialog = true
      }
      else{
        item.count +=1
        var flag = 0
        if(this.$store.state.cart.length != 0){
          for (let index = 0; index < this.$store.state.cart.length; index++) {
            if(item._id == this.$store.state.cart[index]._id){
              this.$store.state.cart[index].count += 1
              this.$store.state.cart[index].total_price = Number(this.$store.state.cart[index].count) * Number(this.$store.state.cart[index].price)
              flag = 1
              break
            }
          }
          if(flag == 0){
            let temp = {
              "_id": item._id,
              "item": item.item,
              "price": item.price,
              "total_price": Number(item.price)*Number(item.count),
              "count": 1,
              "sides_total_price": 0,
              "configure": {
                "sides": []
              }
            }
            this.$store.state.cart.push(temp)
          }
        }
        else{
          let temp = {
            "_id": item._id,
            "item": item.item,
            "price": item.price,
            "total_price": item.price*item.count,
            "count": 1,
            "sides_total_price": 0,
            "configure": {
              "sides": []
            }
          }
          this.$store.state.cart.push(temp)
        }
      }
    },
    adding_cart: function(object, config){
      config.sort()
      object.count +=1
      var isObject = function (object) {
        return object != null && typeof object === 'object';
      }
      var deepEqual = function (object1, object2) {
        console.log("Checking if equal", object2)
        var keys1 = Object.keys(object1);
        var keys2 = Object.keys(object2);
        const toRemove = ["category", "description", "price", "total_price", "count", "sides_total_price"]
        keys1 = keys1.filter( ( el ) => !toRemove.includes( el ) )
        keys2 = keys2.filter( ( el ) => !toRemove.includes( el ) )
        if (keys1.length !== keys2.length) {
          console.log("Not equal1")
          return false;
        }

        for (const key of keys1) {
          console.log(key)
          const val1 = object1[key];
          const val2 = object2[key];
          const areObjects = isObject(val1) && isObject(val2);
          console.log("areObjects",val1,val2)
          if (
            areObjects && !deepEqual(val1, val2) ||
            !areObjects && val1 !== val2
          ) {
            console.log("Not equal2")
            return false;
          }
        }
        console.log("Equal")

        return true;
      }
      if(this.$store.state.cart.length == 0){
        if(config.length == 0){
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "sides_total_price": 0,
            "total_price": Number(object.price)*Number(object.count),
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          this.$store.state.cart.push(temp)
        }
        else{
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "sides_total_price": 0,
            "total_price": object.price*object.count,
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          for (let index = 0; index < config.length; index++) {
            temp.configure.sides.push(object.configure.sides[config[index]])
            // temp.configure.sides[index].count = 1
            temp.sides_total_price += Number(temp.configure.sides[index].price)
          }
          temp.total_price = temp.count * (temp.price + temp.sides_total_price)
          this.$store.state.cart.push(temp)
        }
      }
      else{
        var flag = 0
        if(config.length == 0){
          for (let index = 0; index < this.$store.state.cart.length; index++) {
            if(this.$store.state.cart[index].configure.sides.length == 0){
              if(object._id == this.$store.state.cart[index]._id){
                this.$store.state.cart[index].count += 1
                this.$store.state.cart[index].total_price = Number(this.$store.state.cart[index].count) * Number(this.$store.state.cart[index].price)
                flag = 1
                break
              }
            }
          }
          if(flag == 0){
            let temp = {
              "_id": object._id,
              "item": object.item,
              "price": object.price,
              "sides_total_price": 0,
              "total_price": Number(object.price),
              "count": 1,
              "configure": {
                "sides": []
              }
            }
            this.$store.state.cart.push(temp)
          }
        }
        else{
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "sides_total_price": 0,
            "total_price": 0,
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          for (let index = 0; index < config.length; index++) {
            temp.configure.sides.push(object.configure.sides[config[index]])
          }
          for (let index = 0; index < this.$store.state.cart.length; index++) {
            console.log("Checking")
            if(deepEqual(temp,this.$store.state.cart[index])){
              console.log("EXIST")
              this.$store.state.cart[index].count += 1
              for (let index = 0; index < config.length; index++) {
                temp.sides_total_price += Number(temp.configure.sides[index].price)
              }
              this.$store.state.cart[index].total_price = Number(this.$store.state.cart[index].count) * (Number(this.$store.state.cart[index].price) + temp.sides_total_price)
              flag = 1
              break
            }
          }
          if(flag == 0){
            for (let index = 0; index < config.length; index++) {
              temp.sides_total_price += Number(temp.configure.sides[index].price)
            }
            temp.total_price = temp.count * (temp.price + temp.sides_total_price)
            this.$store.state.cart.push(temp)
          }

        console.log(temp)
        }
      }
      this.config = []
      this.dialog = false
    },
    increase: function(id,index){
      this.$store.state.cart[index].count ++
      this.$store.state.cart[index].total_price = (this.$store.state.cart[index].price + this.$store.state.cart[index].sides_total_price) * this.$store.state.cart[index].count
      for (const index1 in this.$store.state.group_by_category) {
        var a = this.$store.state.group_by_category[index1].find(item => item._id == id)
        if(a){
          a.count++
        }
      }
    },
    decrease: function(id,index){
      this.$store.state.cart[index].count--
      this.$store.state.cart[index].total_price = (this.$store.state.cart[index].price + this.$store.state.cart[index].sides_total_price) * this.$store.state.cart[index].count
      for (const index1 in this.$store.state.group_by_category) {
        var a = this.$store.state.group_by_category[index1].find(item => item._id == id)
        if(a){
          a.count--
          break
        }
      }
      if(this.$store.state.cart[index].count == 0){
        this.$store.state.cart.splice(index,1)
      }
    },
    closing_dialog: function(){
      this.config = []
      this.dialog = false
    }

  },
  computed: {
    configlist(){
      return this.info.filter(i => i.col === 'one')
    },
    total_cart_price: function(){
      return (this.$store.state.cart.reduce((prev, cur) => prev + cur.total_price, 0))
    }
  },
  created(){
    this.address = this.$store.state.address
    if(!this.address.street){
      this.$router.push('/order')
    }
    if(this.$store.state.group_by_category == ""){
      this.$axios.get('http://localhost:3000/menu')
      .then(response => {
        this.menu = response.data
        this.$store.state.group_by_category = groupBy(this.menu, 'category')
      })
      var groupBy = function(xs, key) {
        return xs.reduce(function(rv, x) {
          (rv[x[key]] = rv[x[key]] || []).push(x)
          return rv
        }, {})
      }
    }
    // this.menu = this.$store.state.menu
  }
}
</script>


<template>
  <v-container>
    <v-row>
      <v-col cols='12' class="align-center py-0 my-0">
        <v-btn :ripple="false" link text class="px-0 back_button" to="/order/delivery">
          <v-icon align='center' justify='center' class="mr-3 mt-0">mdi-chevron-left</v-icon>
          <span class="text-h6 text-capitalize font-weight-bold text-decoration-underline">Back</span>
        </v-btn>
      </v-col>
      {{$store.state.cart}}
      <v-col cols='8'>
        <v-card flat class="d-flex align-center pl-0 py-5 mb-7" to="/order/delivery/new">
          <v-row class="align-center" align='center'>
            <v-col class="d-flex align-center">
              <v-icon color="#E0CF5E" size='25' class="delivery_icon mr-5">mdi-basket-outline</v-icon>
              <span class="text-subtitle-1 font-weight-bold">{{$store.state.address.type}} : {{$store.state.address.house}}, {{$store.state.address.street}}, {{$store.state.address.city}}, {{$store.state.address.pincode}}</span>
            </v-col>
          </v-row>
        </v-card>
        <v-divider class="mt-5 "></v-divider>
      </v-col>
      <v-col cols='8'>
        <v-expansion-panels multiple flat light v-model="openedPanels">
          <v-expansion-panel
            v-for="(types,i) in Object.keys($store.state.group_by_category)"
            :key="i"
            class="pb-4"
          >
            <v-card class="pa-0 primary--text" outlined tile>
              <v-card-title class="pa-0">
                <v-expansion-panel-header class="text-h6 font-weight-regular">
                  {{types}}
                  <template v-slot:actions>
                    <v-icon color="primary">mdi-menu-down</v-icon>
                  </template>
                </v-expansion-panel-header>
              </v-card-title>
            </v-card>
            <v-expansion-panel-content>
              <v-list two-line>
                  <v-row>
                    <template v-for="(item,j) in $store.state.group_by_category[types]">
                      <v-col cols="6" :key="j">
                          <v-list-item :class="{primary: item.count > 0}">
                            <template>
                              <v-list-item-content @click="selecting(item)" style="cursor: pointer">
                                <v-list-item-title class="text-h6 mb-3 forth--text font-weight-bold" v-text="item.item"></v-list-item-title>
                                <v-list-item-subtitle v-text="item.description"></v-list-item-subtitle>
                              </v-list-item-content>
                              <v-list-item-action>
                                <v-list-item-action-text class="text-h5 font-weight-bold forth--text" v-text="'CA$'+item.price"></v-list-item-action-text>
                                <span v-if="item.count!=0">
                                  <v-btn small outlined icon color="forth" @click="item.count--, menu_decrease(item._id)">
                                    -
                                  </v-btn>
                                  {{item.count}}
                                  <v-btn small outlined icon color="forth" @click="item.count++, menu_increase(item._id)">
                                    +
                                  </v-btn>
                                </span>
                              </v-list-item-action>
                            </template>
                          </v-list-item>
                        <v-divider v-if="j + 1 < types.length" :key="'divider'+j"></v-divider>
                      </v-col>
                    </template>
                  </v-row>
                <!-- </v-list-item-group> -->
              </v-list>
            </v-expansion-panel-content>
          </v-expansion-panel>
        </v-expansion-panels>
        <v-dialog
          persistent
          v-model="dialog"
          max-width="500px"
        >
          <v-card>
            <v-card-title v-if="dialog_object!=null">
              {{dialog_object.item}}
            </v-card-title>
            <v-list v-if="dialog_object!=null">
              <v-list-item-group
                v-model="config"
                multiple
              >
                <template>
                  <v-list-item
                    v-for="(item, i) in dialog_object.configure.sides"
                    :key="`item-${i}`"
                    :value="item.item"
                    active-class="deep-purple--text text--accent-4"
                  >
                    <template v-slot:default="{ active }">
                      <v-list-item-content>
                        <v-list-item-title v-text="item.name">
                        </v-list-item-title>
                      </v-list-item-content>

                      <v-list-item-action>
                        <v-checkbox
                          :ripple="false"
                          :input-value="active"
                          color="deep-purple accent-4"
                        ></v-checkbox>
                      </v-list-item-action>
                    </template>
                  </v-list-item>
                </template>
              </v-list-item-group>
            </v-list>
            <v-card-actions>
              <v-btn
                color="primary"
                text
                @click="closing_dialog"
              >
                Close
              </v-btn>
              <v-spacer></v-spacer>
              <v-btn
                color="primary"
                text
                @click="adding_cart(dialog_object,config)"
              >
                Add
              </v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-col>
      <v-col>
        <v-card v-if="$store.state.loggedIn" class="pa-5 white--text mb-5" outlined tile>
          <div>
            <v-text-field
            v-model="name"
            solo
            flat
            class="ma-0 pa-0" hide-details
            label="Name"
            prepend-icon="mdi-face"
            ></v-text-field>
            <v-text-field
            v-model="$store.state.user.mobile"
            solo
            flat
            class="ma-0 pa-0" hide-details
            label="Mobile Number"
            prepend-icon="mdi-phone"
            ></v-text-field>
            <v-text-field
            v-model="$store.state.user.email"
            solo
            flat
            class="ma-0 pa-0" hide-details
            label="Email"
            prepend-icon="mdi-mail"
            ></v-text-field>
            <v-text-field
            v-model="$store.state.user.cardpay"
            solo
            flat
            class="ma-0 pa-0" hide-details
            label="Payment Method"
            prepend-icon="mdi-card"
            ></v-text-field>
            <v-checkbox
              v-model="$store.state.user.promotionreceive"
              class="ma-0 py-3"
              hide-details
              label="Receive promotions"
              required
            ></v-checkbox>
            <v-btn
              text
              color="blue-grey"
              class="pl-0 white--text"
              @click="loggingOut"
            >
              <v-icon class="mr-5">mdi-cloud-upload</v-icon>
              Logout
            </v-btn>
          </div>
        </v-card>
        <v-card v-else class="pa-5 white--text mb-5" outlined tile>
          <v-dialog v-model="$store.state.dialog2" fullscreen hide-overlay transition="dialog-bottom-transition">
            <template v-slot:activator="{ on, attrs }">
              <v-btn x-large block depressed :ripple="false" tile color="primary"
                v-bind="attrs"
                v-on="on"
              >
                LOGIN
              </v-btn>
            </template>
            <!-- class="d-flex flex-column align-center justify-center" -->
            <v-card>
              <v-toolbar flat color="primary" dark>
                <v-toolbar-title>User Login / SignUp</v-toolbar-title>
                <v-spacer></v-spacer>
                <v-btn color="forth" text @click="$store.state.dialog2 = false">Cancle</v-btn>
                <template v-slot:extension>
                  <v-tabs centered dark icons-and-text fixed-tabs v-model="activeTab">
                    <v-tab>
                      <v-icon left>mdi-lock</v-icon>
                      Login
                    </v-tab>
                    <v-tab>
                      <v-icon left>mdi-account</v-icon>
                      Sign Up
                    </v-tab>
                  </v-tabs>
                </template>
              </v-toolbar>
              <v-tabs-items v-model="activeTab">
                <v-tab-item >
                  <v-container class="mt-3">
                    <login v-on:change-tab="activeTab = 1"/>
                  </v-container>
                </v-tab-item>
                <v-tab-item>
                  <v-container class="mt-3">
                    <signup/>
                  </v-container>
                </v-tab-item>
              </v-tabs-items>
            </v-card>
          </v-dialog>
        </v-card>
        <v-card class="pa-0 white--text" outlined tile>
          <v-card-title class="headline primary px-5">
            Basket
            <v-spacer></v-spacer>
            CA${{total_cart_price.toFixed(2)}}
          </v-card-title>
          <v-card-text v-if="$store.state.cart.length==0">
            <v-card flat>
              <v-card-title>
                Your cart is empty
              </v-card-title>
            </v-card>
          </v-card-text>
          <v-card-text v-else>
            <v-list two-line>
              <template v-for="(item,j) in $store.state.cart" >
                <v-list-item :key="j">
                  <template>
                    <v-list-item-content>
                      <v-list-item-title class="text-h6 mb-3 forth--text font-weight-bold" v-text="item.item"></v-list-item-title>
                      <v-list-item-subtitle v-for="i in item.configure.sides" v-text="i.name" :key="i.name"></v-list-item-subtitle>
                    </v-list-item-content>
                    <v-list-item-action>
                      <v-list-item-action-text class="text-h5 font-weight-bold forth--text" v-text="'CA$'+item.total_price.toFixed(2)"></v-list-item-action-text>
                      <span>
                        <v-btn outlined icon color="grey lighten-1" @click="cart_decrease(item._id,j)">
                          -
                        </v-btn>
                        {{item.count}}
                        <v-btn outlined icon color="grey lighten-1" @click="cart_increase(item._id,j)">
                          +
                        </v-btn>
                      </span>
                    </v-list-item-action>
                  </template>
                </v-list-item>
                <v-divider :inset="inset" :key="'divider'+j"></v-divider>
                <!-- <v-divider v-if="j + 1 < types.length" :key="j"></v-divider> -->
              </template>
            </v-list>
          </v-card-text>
          <v-card-actions class="pa-5" v-if="$store.state.cart.length>0">
            <v-btn x-large block depressed :ripple="false" tile color="primary">Preorder</v-btn>
          </v-card-actions>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>
<script>
import login from "../../../outer/login/index"
import signup from "../../../outer/register/index"
// import { mapState } from 'vuex'
export default {
  components:{
    login,
    signup
  },
  data:() => ({
    loggedIn: false,
    inset: false,
    openedPanels: [0,1,2],
    dialog: false,
    activeTab: null,
    selected: [],
    menu: null,
    dialog_object: null,
    config:[],
    item_price: 0,
    total_price: 0
  }),
  watch: {
    // $store.state.cart(){
    //   $store.state.cart =
    // },
    name() {
      setTimeout(() => {
        console.log('waiting')
      }, 5000).then((val)=>{
        console.log(val)
      })
    },
  },
  methods: {
    mouseLeave: function() {
        alert('Mouse Leave')
    },
    selecting: function(item){
      if(item.configure){
        this.dialog_object = item
        this.dialog = true
      }
      else{
        item.count +=1
        var flag = 0
        if(this.$store.state.cart.length != 0){
          for (let index = 0; index < this.$store.state.cart.length; index++) {
            if(item._id == this.$store.state.cart[index]._id){
              this.$store.state.cart[index].count += 1
              this.$store.state.cart[index].total_price = Number(this.$store.state.cart[index].count) * Number(this.$store.state.cart[index].price)
              flag = 1
              break
            }
          }
          if(flag == 0){
            let temp = {
              "_id": item._id,
              "item": item.item,
              "price": item.price,
              "total_price": Number(item.price)*Number(item.count),
              "count": 1,
              "sides_total_price": 0,
              "configure": {
                "sides": []
              }
            }
            this.$store.state.cart.push(temp)
          }
        }
        else{
          let temp = {
            "_id": item._id,
            "item": item.item,
            "price": item.price,
            "total_price": item.price*item.count,
            "count": 1,
            "sides_total_price": 0,
            "configure": {
              "sides": []
            }
          }
          this.$store.state.cart.push(temp)
        }
      }
    },
    adding_cart: function(object, config){
      config.sort()
      object.count +=1
      var isObject = function (object) {
        return object != null && typeof object === 'object';
      }
      var deepEqual = function (object1, object2) {
        console.log("Checking if equal", object2)
        var keys1 = Object.keys(object1);
        var keys2 = Object.keys(object2);
        const toRemove = ["category", "description", "price", "total_price", "count", "sides_total_price"]
        keys1 = keys1.filter( ( el ) => !toRemove.includes( el ) )
        keys2 = keys2.filter( ( el ) => !toRemove.includes( el ) )
        if (keys1.length !== keys2.length) {
          console.log("Not equal1")
          return false;
        }

        for (const key of keys1) {
          console.log(key)
          const val1 = object1[key];
          const val2 = object2[key];
          const areObjects = isObject(val1) && isObject(val2);
          console.log("areObjects",val1,val2)
          if (
            areObjects && !deepEqual(val1, val2) ||
            !areObjects && val1 !== val2
          ) {
            console.log("Not equal2")
            return false;
          }
        }
        console.log("Equal")

        return true;
      }
      if(this.$store.state.cart.length == 0){
        if(config.length == 0){
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "sides_total_price": 0,
            "total_price": Number(object.price)*Number(object.count),
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          this.$store.state.cart.push(temp)
        }
        else{
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "sides_total_price": 0,
            "total_price": object.price*object.count,
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          for (let index = 0; index < config.length; index++) {
            temp.configure.sides.push(object.configure.sides[config[index]])
            // temp.configure.sides[index].count = 1
            temp.sides_total_price += Number(temp.configure.sides[index].price)
          }
          temp.total_price = temp.count * (temp.price + temp.sides_total_price)
          this.$store.state.cart.push(temp)
        }
      }
      else{
        var flag = 0
        if(config.length == 0){
          for (let index = 0; index < this.$store.state.cart.length; index++) {
            if(this.$store.state.cart[index].configure.sides.length == 0){
              if(object._id == this.$store.state.cart[index]._id){
                this.$store.state.cart[index].count += 1
                this.$store.state.cart[index].total_price = Number(this.$store.state.cart[index].count) * Number(this.$store.state.cart[index].price)
                flag = 1
                break
              }
            }
          }
          if(flag == 0){
            let temp = {
              "_id": object._id,
              "item": object.item,
              "price": object.price,
              "sides_total_price": 0,
              "total_price": Number(object.price),
              "count": 1,
              "configure": {
                "sides": []
              }
            }
            this.$store.state.cart.push(temp)
          }
        }
        else{
          let temp = {
            "_id": object._id,
            "item": object.item,
            "price": object.price,
            "sides_total_price": 0,
            "total_price": 0,
            "count": 1,
            "configure": {
              "sides": []
            }
          }
          for (let index = 0; index < config.length; index++) {
            temp.configure.sides.push(object.configure.sides[config[index]])
          }
          for (let index = 0; index < this.$store.state.cart.length; index++) {
            console.log("Checking")
            if(deepEqual(temp,this.$store.state.cart[index])){
              console.log("EXIST")
              this.$store.state.cart[index].count += 1
              for (let index = 0; index < config.length; index++) {
                temp.sides_total_price += Number(temp.configure.sides[index].price)
              }
              this.$store.state.cart[index].total_price = Number(this.$store.state.cart[index].count) * (Number(this.$store.state.cart[index].price) + temp.sides_total_price)
              flag = 1
              break
            }
          }
          if(flag == 0){
            for (let index = 0; index < config.length; index++) {
              temp.sides_total_price += Number(temp.configure.sides[index].price)
            }
            temp.total_price = temp.count * (temp.price + temp.sides_total_price)
            this.$store.state.cart.push(temp)
          }

        console.log(temp)
        }
      }
      this.config = []
      this.dialog = false
    },
    cart_increase: function(id,index){
      console.log(id)
      this.$store.state.cart[index].count ++
      this.$store.state.cart[index].total_price = (this.$store.state.cart[index].price + this.$store.state.cart[index].sides_total_price) * this.$store.state.cart[index].count
      for (const index1 in this.$store.state.group_by_category) {
        var a = this.$store.state.group_by_category[index1].find(item => item._id == id)
        if(a){
          a.count++
        }
      }
    },

    cart_decrease: function(id,index){
      this.$store.state.cart[index].count --
      this.$store.state.cart[index].total_price = (this.$store.state.cart[index].price + this.$store.state.cart[index].sides_total_price) * this.$store.state.cart[index].count
      for (const index1 in this.$store.state.group_by_category) {
        var a = this.$store.state.group_by_category[index1].find(item => item._id == id)
        if(a){
          a.count--
          if(this.$store.state.cart[index].count == 0){
            this.$store.state.cart.splice(index,1)
          }
        }
      }
    },
    menu_increase: function(id){
      var index = this.$store.state.cart.map(e => e._id).lastIndexOf(id)
      if(index == -1){
        console.log()
      }
      else{
        this.$store.state.cart[index].count++
      }
    },
    menu_decrease: function(id){
      var index = this.$store.state.cart.map(e => e._id).lastIndexOf(id)
      if(index == -1){
        console.log()
      }
      else{
        this.$store.state.cart[index].count--
        if(this.$store.state.cart[index].count == 0){
          this.$store.state.cart.splice(index,1)
        }
      }
    },
    closing_dialog: function(){
      this.config = []
      this.dialog = false
    },
    loggingOut:function () {
      var that = this;
      that.$axios.get('http://localhost:3000/user/logout')
      .then(function(res) {
          that.$store
            .dispatch("removeTokenForUser", {
              token: res.data,
            })
          that.$store.state.loggedIn = false
        })
    }

  },
  computed: {
    // ...mapState(['$store.state.cart', '$store.state.group_by_category', '$store.state.address', 'user']),
    name : {
      get () {
        return this.username
      },
      set (value) {
        this.$store.commit('updateUsername', value)
      }
    },
    configlist(){
      return this.info.filter(i => i.col === 'one')
    },
    total_cart_price: function(){
      return (this.$store.state.cart.reduce((prev, cur) => prev + cur.total_price, 0))
    }
  },
  created(){
    console.log(window.localStorage.getItem("location"))
    this.$store.state.address = JSON.parse(window.localStorage.getItem("location"))
    if(!this.$store.state.address.street){
      this.$router.push('/order')
    }
    if(this.$store.state.group_by_category == ""){
      this.$axios.get('http://localhost:3000/menu')
      .then(response => {
        this.menu = response.data
        this.$store.state.group_by_category = groupBy(this.menu, 'category')
      })
      var groupBy = function(xs, key) {
        return xs.reduce(function(rv, x) {
          (rv[x[key]] = rv[x[key]] || []).push(x)
          return rv
        }, {})
      }
    }
    // this.menu = this.$store.state.menu
  }
}
</script>
<style scoped>
.activeClass{
  color: yellow;
}
</style>
// <v-menu persistent v-model="dialog" :nudge-width="200" offset-x>
  // <v-card>
  //   <v-card-title>
  //     {{dialog_object.item}}
  //   </v-card-title>
  //   <v-card-actions>
  //     <v-btn
  //       color="primary"
  //       text
  //       @click="dialog=false"
  //     >
  //       Close
  //     </v-btn>
  //   </v-card-actions>
  // </v-card>
// </v-menu>